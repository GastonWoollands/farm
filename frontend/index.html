<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f766e">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.jpg" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.jpg">
  <link rel="stylesheet" href="styles.css">
  <title>Counter farm</title>
  <script defer src="/_vercel/insights/script.js"></script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
  <!-- Configuration -->
  <script src="config.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    // Use config from config.js
    const firebaseConfig = window.FIREBASE_CONFIG;
    
    if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === 'your-actual-api-key-here') {
      console.error('Firebase configuration not set. Please update config.js with your Firebase project details.');
      document.body.innerHTML = '<div style="text-align:center; padding:2rem; color:#c33;"><h2>Configuration Required</h2><p>Please update config.js with your Firebase project details.</p></div>';
    } else {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      window.firebaseAuth = auth;
    }
  </script>
</head>
<body>
  <header class="app-header">
    <h1>Counter farm <small id="pending-count" class="muted" style="font-size:12px; margin-left:8px;"></small></h1>
    <div style="display:flex; align-items:center; gap:12px;">
      <span class="badge" id="status-badge">Offline</span>
      <button id="signout-btn" class="btn" style="display:none; padding:6px 12px; font-size:12px;">Cerrar Sesión</button>
    </div>
  </header>

  <main class="container" id="auth-screen" hidden>
    <section class="card" style="max-width:400px; margin:2rem auto;">
      <div style="text-align:center; margin-bottom:2rem;">
        <h2 style="margin:0 0 0.5rem 0; color:#0f766e;">Counter farm</h2>
        <p class="muted">Inicia sesión para continuar</p>
      </div>
      
      <form id="auth-form">
        <div class="form-field">
          <input id="auth-email" name="email" type="email" placeholder="Email" required autocomplete="email" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:16px;">
        </div>
        <div class="form-field">
          <input id="auth-password" name="password" type="password" placeholder="Contraseña" required autocomplete="current-password" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:16px;">
        </div>
        
        <button type="submit" class="btn primary" id="signin-btn" style="width:100%; padding:12px; margin:8px 0; font-size:16px; background:#0f766e; border:none; border-radius:6px; color:white; cursor:pointer;">
          Iniciar Sesión
        </button>
        
        <div style="text-align:center; margin:1rem 0;">
          <span class="muted">¿No tienes cuenta? </span>
          <button type="button" class="btn" id="signup-btn" style="background:none; border:none; color:#0f766e; text-decoration:underline; cursor:pointer; font-size:14px;">
            Regístrate aquí
          </button>
        </div>
        
        <div id="auth-message" style="text-align:center; margin:1rem 0; padding:8px; border-radius:4px;" hidden></div>
      </form>
    </section>
  </main>

  <main class="container" id="app-screen" hidden>
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button id="metrics-tab" class="nav-tab active">Métricas</button>
      <button id="cows-tab" class="nav-tab">Vacas</button>
      <button id="pigs-tab" class="nav-tab">Cerdos</button>
      <button id="search-tab" class="nav-tab">Buscar</button>
      <button id="objectives-tab" class="nav-tab">Objetivos</button>
    </div>

    <!-- Metrics Page -->
    <div id="metrics-page">
      <div id="metrics-container"></div>
    </div>

    <!-- Cows Page -->
    <div id="cows-page" hidden>
      <section class="card">
        <div class="row space-between align-center">
          <h2>Vacas</h2>
          <div class="row gap">
            <button id="register-cow-btn" class="btn primary">Registrar Nuevo Animal</button>
            <button id="manage-synced-cows" class="btn">Gestionar registros…</button>
            <button id="export-csv-cows" class="btn">Exportar CSV</button>
          </div>
        </div>

        <!-- Registration form -->
        <section id="register-cow-section" hidden>
          <form id="inline-add-cow" class="form-vertical" style="margin:8px 0 12px;">
            <input type="hidden" id="inline-animal-type" value="1">
            <div class="form-field">
              <label for="inline-animal-cow">ID de la Vaca (requerido)</label>
              <input id="inline-animal-cow" type="text" placeholder="e.g., 123-45" autocomplete="off" required>
            </div>
            <div class="form-field">
              <label for="inline-mother-cow">Madre ID (opcional)</label>
              <input id="inline-mother-cow" type="text" placeholder="e.g., 67890" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-born-cow">Nacimiento (opcional)</label>
              <input id="inline-born-cow" type="date" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-weight-cow">Peso (kg, opcional)</label>
              <input id="inline-weight-cow" type="number" step="0.01" min="0" placeholder="e.g., 250.5" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-gender-cow">Sexo (opcional)</label>
              <select id="inline-gender-cow">
                <option value="">— Seleccionar —</option>
                <option value="MALE">Macho</option>
                <option value="FEMALE">Hembra</option>
                <option value="UNKNOWN">Desconocido</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-status-cow">Estado (opcional)</label>
              <select id="inline-status-cow">
                <option value="">— Seleccionar —</option>
                <option value="ALIVE" selected>Vivo</option>
                <option value="DEAD">Muerto</option>
                <option value="UNKNOWN">Desconocido</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-color-cow">Color (opcional)</label>
              <select id="inline-color-cow">
                <option value="">— Seleccionar —</option>
                <option value="COLORADO">Colorado</option>
                <option value="NEGRO">Negro</option>
                <option value="OTHERS">Otros</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-notes-mother-cow">Notas de la madre (opcional)</label>
              <input id="inline-notes-mother-cow" type="text" placeholder="Cualquier nota sobre la madre" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-notes-cow">Notas (opcional)</label>
              <input id="inline-notes-cow" type="text" placeholder="Cualquier nota" autocomplete="off">
            </div>
            <div class="row gap">
              <button class="btn primary" id="inline-add-cow-btn" type="submit" aria-label="Registrar vaca">Registrar Vaca</button>
            </div>
          </form>
        </section>

        <ul id="cows-records" class="list"></ul>
      </section>
    </div>

    <!-- Pigs Page -->
    <div id="pigs-page" hidden>
      <section class="card">
        <div class="row space-between align-center">
          <h2>Cerdos</h2>
          <div class="row gap">
            <button id="register-pig-btn" class="btn primary">Registrar Nuevo Cerdo</button>
            <button id="manage-synced-pigs" class="btn">Gestionar registros…</button>
            <button id="export-csv-pigs" class="btn">Exportar CSV</button>
          </div>
        </div>

        <!-- Registration form -->
        <section id="register-pig-section" hidden>
          <form id="inline-add-pig" class="form-vertical" style="margin:8px 0 12px;">
            <input type="hidden" id="inline-animal-type-pig" value="2">
            <div class="form-field">
              <label for="inline-animal-pig">ID del Cerdo (requerido)</label>
              <input id="inline-animal-pig" type="text" placeholder="e.g., 123-45" autocomplete="off" required>
            </div>
            <div class="form-field">
              <label for="inline-mother-pig">Madre ID (opcional)</label>
              <input id="inline-mother-pig" type="text" placeholder="e.g., 67890" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-born-pig">Nacimiento (opcional)</label>
              <input id="inline-born-pig" type="date" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-weight-pig">Peso (kg, opcional)</label>
              <input id="inline-weight-pig" type="number" step="0.01" min="0" placeholder="e.g., 50.5" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-gender-pig">Sexo (opcional)</label>
              <select id="inline-gender-pig">
                <option value="">— Seleccionar —</option>
                <option value="MALE">Macho</option>
                <option value="FEMALE">Hembra</option>
                <option value="UNKNOWN">Desconocido</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-status-pig">Estado (opcional)</label>
              <select id="inline-status-pig">
                <option value="">— Seleccionar —</option>
                <option value="ALIVE" selected>Vivo</option>
                <option value="DEAD">Muerto</option>
                <option value="UNKNOWN">Desconocido</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-color-pig">Color (opcional)</label>
              <select id="inline-color-pig">
                <option value="">— Seleccionar —</option>
                <option value="ROSA">Rosa</option>
                <option value="NEGRO">Negro</option>
                <option value="BLANCO">Blanco</option>
                <option value="MARRON">Marrón</option>
                <option value="OTHERS">Otros</option>
              </select>
            </div>
            <div class="form-field">
              <label for="inline-notes-mother-pig">Notas de la madre (opcional)</label>
              <input id="inline-notes-mother-pig" type="text" placeholder="Cualquier nota sobre la madre" autocomplete="off">
            </div>
            <div class="form-field">
              <label for="inline-notes-pig">Notas (opcional)</label>
              <input id="inline-notes-pig" type="text" placeholder="Cualquier nota" autocomplete="off">
            </div>
            <div class="row gap">
              <button class="btn primary" id="inline-add-pig-btn" type="submit" aria-label="Registrar cerdo">Registrar Cerdo</button>
            </div>
          </form>
        </section>

        <ul id="pigs-records" class="list"></ul>
      </section>
    </div>

    <!-- Search Page -->
    <div id="search-page" hidden>
      <section class="card">
        <div class="row space-between align-center">
          <h2>Buscar Animales</h2>
        </div>

        <!-- Search interface -->
        <div id="search-interface-container"></div>

        <!-- Search results -->
        <div id="search-results-container"></div>
      </section>
    </div>

    <!-- Objectives Page -->
    <div id="objectives-page" hidden>
      <section class="card">
        <div class="row space-between align-center">
          <h2>Objetivos del Año</h2>
        </div>

        <!-- Objectives content will be rendered here -->
        <div id="objectives-container"></div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <small>
      Status: <span id="sync-status">Idle</span>
      • API: <code id="api-base"></code>
    </small>
  </footer>

  <!-- Fixed Cafecito Button -->
  <div class="cafecito-fixed">
    <a href='https://cafecito.app/wg83' rel='noopener' target='_blank' class="cafecito-link">
      <img srcset='https://cdn.cafecito.app/imgs/buttons/button_2.png 1x, https://cdn.cafecito.app/imgs/buttons/button_2_2x.png 2x, https://cdn.cafecito.app/imgs/buttons/button_2_3.75x.png 3.75x' 
           src='https://cdn.cafecito.app/imgs/buttons/button_2.png' 
           alt='Invitame un café en cafecito.app' 
           class="cafecito-button" />
    </a>
  </div>

  <script type="module" src="app/main.js"></script>
  <div id="toast" role="status" aria-live="polite" hidden></div>
  <dialog id="manage-synced-dialog">
    <div class="row space-between align-center">
      <h3 style="margin:0;">Gestionar registros sincronizados</h3>
      <form method="dialog">
        <button class="btn" value="close">Cerrar</button>
      </form>
    </div>
    <ul id="manage-synced-list" class="list" style="margin-top:8px;"></ul>
  </dialog>
  <dialog id="export-dialog">
    <form method="dialog" class="form-vertical">
      <h3 style="margin:0 0 8px 0;">Exportar por fecha de nacimiento</h3>
      <div class="row gap" style="align-items:center;">
        <label class="muted" for="export-start-modal">Desde</label>
        <input id="export-start-modal" type="date" aria-label="Desde fecha de nacimiento" />
        <label class="muted" for="export-end-modal">Hasta</label>
        <input id="export-end-modal" type="date" aria-label="Hasta fecha de nacimiento" />
      </div>
      <div class="row gap" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn" value="cancel" id="export-cancel">Cancelar</button>
        <button class="btn primary" value="confirm" id="export-confirm">Exportar</button>
      </div>
    </form>
  </dialog>
</body>
</html>

