name: Daily Father Assignment

on:
  schedule:
    - cron: "0 3 * * *"   # Daily at 3 AM UTC
  workflow_dispatch:      # Allow manual execution from GitHub

jobs:
  father-assignment:
    runs-on: ubuntu-latest

    steps:
    - name: Run Father Assignment
      env:
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
        ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
        GESTATION_DAYS: ${{ secrets.GESTATION_DAYS || '300' }}
      run: |
        echo "üêÑ Daily Father Assignment - $(date)"
        echo "====================================="
        
        # Run the father assignment process
        RESPONSE=$(curl -s -X POST \
          -H "X-Admin-Secret: $ADMIN_SECRET" \
          -H "Content-Type: application/json" \
          "$API_BASE_URL/father-assignment/process?dry_run=false&gestation_days=$GESTATION_DAYS")
        
        # Extract and display key results
        TOTAL=$(echo "$RESPONSE" | grep -o '"total_processed":[0-9]*' | cut -d':' -f2)
        ASSIGNED=$(echo "$RESPONSE" | grep -o '"assigned":[0-9]*' | cut -d':' -f2)
        REPASO=$(echo "$RESPONSE" | grep -o '"repaso":[0-9]*' | cut -d':' -f2)
        NO_INSEMINATION=$(echo "$RESPONSE" | grep -o '"no_insemination":[0-9]*' | cut -d':' -f2)
        ERRORS=$(echo "$RESPONSE" | grep -o '"errors":[0-9]*' | cut -d':' -f2)
        
        echo "üìä Results:"
        echo "  Processed: $TOTAL"
        echo "  Assigned: $ASSIGNED"
        echo "  REPASO: $REPASO"
        echo "  No Data: $NO_INSEMINATION"
        echo "  Errors: $ERRORS"
        
        if [ "$ASSIGNED" -gt 0 ]; then
          echo "‚úÖ Successfully assigned $ASSIGNED father IDs!"
        elif [ "$NO_INSEMINATION" -gt 0 ]; then
          echo "‚ÑπÔ∏è  No insemination data found for $NO_INSEMINATION registrations"
        else
          echo "‚ÑπÔ∏è  No registrations needed processing"
        fi